<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Ticket Summarizer</title>
  <script src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 13px;
      padding: 12px;
    }

    h3 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 16px;
    }

    h4 {
      margin-bottom: 8px;
      margin-top: 16px;
      font-size: 14px;
    }

    .tone-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tone-pill {
      border: 1px solid #d8dcde;
      border-radius: 16px;
      padding: 6px 12px;
      cursor: pointer;
      background: #f8f9f9;
      user-select: none;
      font-size: 12px;
    }

    .tone-pill input {
      display: none;
    }

    .tone-pill:has(input:checked) {
      background: #1f73b7;
      color: white;
      border-color: #1f73b7;
    }

    .primary-btn {
      background: #1f73b7;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      width: 100%;
      font-size: 13px;
      margin-top: 8px;
    }

    .primary-btn:disabled {
      background: #c2d4e8;
      cursor: not-allowed;
    }

    .secondary-btn {
      margin-top: 6px;
      width: 100%;
      border: 1px solid #d8dcde;
      background: white;
      border-radius: 4px;
      padding: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    .secondary-btn:hover {
      background: #f8f9f9;
    }

    .reply-container {
      margin-top: 10px;
    }

    #replyBox, #summaryBox {
      background: #f8f9f9;
      border: 1px solid #d8dcde;
      border-radius: 4px;
      padding: 8px;
      min-height: 100px;
      white-space: pre-wrap;
      font-size: 12px;
      margin-top: 8px;
    }

    hr {
      border: none;
      border-top: 1px solid #d8dcde;
      margin: 16px 0;
    }

    .file-upload-section {
      margin-top: 12px;
      padding: 12px;
      background: #f8f9f9;
      border: 2px dashed #d8dcde;
      border-radius: 4px;
      text-align: center;
    }

    .file-upload-section.dragover {
      background: #e8f4f8;
      border-color: #1f73b7;
    }

    #fileInput {
      display: none;
    }

    .file-label {
      cursor: pointer;
      color: #1f73b7;
      text-decoration: underline;
    }

    .upload-status {
      margin-top: 8px;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .upload-status.success {
      background: #d4f4dd;
      color: #0f5323;
    }

    .upload-status.error {
      background: #ffd5d2;
      color: #8c1d18;
    }

    .upload-status.loading {
      background: #fff4e0;
      color: #8c6d1f;
    }

    .file-info {
      font-size: 11px;
      color: #68737d;
      margin-top: 4px;
    }

    .collapse-section {
      margin-top: 12px;
    }

    .collapse-header {
      cursor: pointer;
      padding: 8px;
      background: #f8f9f9;
      border: 1px solid #d8dcde;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }

    .collapse-header:hover {
      background: #e8ebed;
    }

    .collapse-content {
      display: none;
      padding-top: 8px;
    }

    .collapse-content.open {
      display: block;
    }

    .arrow {
      transition: transform 0.2s;
    }

    .arrow.open {
      transform: rotate(90deg);
    }

    .date-picker-group {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 8px;
    }

    .date-input-wrapper {
      flex: 1;
    }

    .date-input-wrapper label {
      display: block;
      font-size: 11px;
      color: #68737d;
      margin-bottom: 4px;
    }

    .date-input-wrapper input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #d8dcde;
      border-radius: 4px;
      font-size: 12px;
      box-sizing: border-box;
    }

    .auto-import-section {
      margin-top: 12px;
    }

    .import-info {
      background: #e8f4f8;
      border: 1px solid #1f73b7;
      border-radius: 4px;
      padding: 8px;
      font-size: 11px;
      margin-top: 8px;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #f8f9f9;
      border: 1px solid #d8dcde;
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #1f73b7;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 11px;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h3>ü§ñ AI Ticket Assistant</h3>

  <!-- Collapsible Summary Section -->
  <div class="collapse-section">
    <div class="collapse-header" onclick="toggleSection('summarySection')">
      <span>üìù Ticket Summary</span>
      <span class="arrow" id="summaryArrow">‚ñ∂</span>
    </div>
    <div class="collapse-content" id="summarySection">
      <button id="summarizeBtn" class="primary-btn">Generate Summary</button>
      <button id="summarizeBtnNative" class="secondary-btn">Generate Summary in Native Language</button>
      <pre id="summaryBox">Click to generate summary...</pre>
    </div>
  </div>

  <hr />

  <!-- NEW: Auto-Import Tickets Section -->
  <div class="collapse-section">
    <div class="collapse-header" onclick="toggleSection('autoImportSection')">
      <span>üîÑ Auto-Import Tickets from Zendesk</span>
      <span class="arrow" id="autoImportArrow">‚ñ∂</span>
    </div>
    <div class="collapse-content" id="autoImportSection">
      <div class="auto-import-section">
        <div class="date-picker-group">
          <div class="date-input-wrapper">
            <label for="startDate">Start Date</label>
            <input type="date" id="startDate" />
          </div>
          <div class="date-input-wrapper">
            <label for="endDate">End Date</label>
            <input type="date" id="endDate" />
          </div>
        </div>
        
        <button id="autoImportBtn" class="primary-btn">
          üì• Fetch & Import Tickets
        </button>
        
        <div id="importProgress" style="display: none;">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill">0%</div>
          </div>
        </div>
        
        <div id="autoImportStatus"></div>
        
        <div class="import-info">
          ‚ÑπÔ∏è This will fetch all tickets between the selected dates, including their comments and metadata, then automatically import them into the knowledge base.
        </div>
      </div>
    </div>
  </div>

  <hr />

  <!-- Collapsible File Import Section -->
  <div class="collapse-section">
    <div class="collapse-header" onclick="toggleSection('fileImportSection')">
      <span>üìÅ Manual Import (Upload File)</span>
      <span class="arrow" id="fileImportArrow">‚ñ∂</span>
    </div>
    <div class="collapse-content" id="fileImportSection">
      <div class="file-upload-section" id="dropZone">
        <div>
          <p style="margin: 8px 0;">Drop file here or <label for="fileInput" class="file-label">browse</label></p>
          <input type="file" id="fileInput" accept=".txt,.md,.csv,.json" />
          <div class="file-info">Supported: .txt, .md, .csv, .json (max 10MB)</div>
        </div>
        <div id="uploadStatus"></div>
      </div>
    </div>
  </div>

  <hr />

  <!-- Reply Composer Section -->
  <h4>‚ú® AI Reply Composer</h4>

  <div class="tone-group">
    <label class="tone-pill">
      <input type="radio" name="tone" value="professional" />
      Professional
    </label>
    <label class="tone-pill">
      <input type="radio" name="tone" value="friendly" />
      Friendly
    </label>
    <label class="tone-pill">
      <input type="radio" name="tone" value="empathetic" />
      Empathetic
    </label>
    <label class="tone-pill">
      <input type="radio" name="tone" value="apologetic" />
      Apologetic
    </label>
    <label class="tone-pill">
      <input type="radio" name="tone" value="concise" />
      Concise
    </label>
  </div>

  <button id="composeReplyBtn" class="primary-btn">
    ‚ú® Compose Reply
  </button>

  <div class="reply-container">
    <pre id="replyBox">Reply will appear here...</pre>
    <button id="copyReplyBtn" class="secondary-btn">
      üìã Copy to Reply Editor
    </button>
  </div>

  <script>
    const client = ZAFClient.init();

    // Check backend connectivity on load
    async function checkBackendConnection() {
      try {
        const response = await fetch('http://localhost:3000/health', {
          method: 'GET',
          mode: 'cors'
        });
        
        if (response.ok) {
          console.log('‚úÖ Backend is connected and running');
        } else {
          console.warn('‚ö†Ô∏è Backend responded but with error:', response.status);
        }
      } catch (err) {
        console.error('‚ùå Cannot connect to backend server:', err);
        console.error('üí° Make sure your backend is running with: node server.js');
      }
    }

    // Check connection on load
    checkBackendConnection();

    // Set default dates (last 30 days)
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
    document.getElementById('endDate').valueAsDate = today;
    document.getElementById('startDate').valueAsDate = thirtyDaysAgo;

    // Toggle collapsible sections
    function toggleSection(sectionId) {
      const content = document.getElementById(sectionId);
      const arrow = document.getElementById(sectionId.replace('Section', 'Arrow'));
      
      content.classList.toggle('open');
      arrow.classList.toggle('open');
    }

    async function getCompleteTicketData() {
      const ticketData = await client.get('ticket');
      const ticketId = ticketData.ticket.id;

      const ticketResponse = await client.request({
        url: `/api/v2/tickets/${ticketId}.json`,
        type: "GET"
      });
      const ticket = ticketResponse.ticket;

      const formResponse = await client.request({
        url: `/api/v2/ticket_forms/${ticket.ticket_form_id}.json`,
        type: "GET"
      });
      const ticketForm = formResponse.ticket_form;
      const formFieldIds = ticketForm.ticket_field_ids;

      const fieldsResponse = await client.request({
        url: '/api/v2/ticket_fields.json',
        type: 'GET'
      });

      const fieldMap = {};
      fieldsResponse.ticket_fields.forEach(f => {
        fieldMap[f.id] = f.title;
      });

      const usedCustomFields = {};
      ticket.custom_fields.forEach(f => {
        if (formFieldIds.includes(f.id) && f.value !== null && f.value !== "") {
          const title = fieldMap[f.id] || f.id;
          usedCustomFields[title] = f.value;
        }
      });

      return {
        ticketId: ticket.id,
        subject: ticket.subject,
        description: ticket.description,
        status: ticket.status,
        priority: ticket.priority,
        tags: ticket.tags || [],
        ticketFormName: ticketForm.name,
        customFields: usedCustomFields,
        conversation: ""
      };
    }

    // NEW: Auto-Import Tickets Handler
    document.getElementById("autoImportBtn").addEventListener("click", async () => {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const statusDiv = document.getElementById("autoImportStatus");
      const progressDiv = document.getElementById("importProgress");
      const progressFill = document.getElementById("progressFill");
      const btn = document.getElementById("autoImportBtn");

      if (!startDate || !endDate) {
        statusDiv.className = 'upload-status error';
        statusDiv.textContent = "‚ùå Please select both start and end dates";
        return;
      }

      if (new Date(startDate) > new Date(endDate)) {
        statusDiv.className = 'upload-status error';
        statusDiv.textContent = "‚ùå Start date must be before end date";
        return;
      }

      btn.disabled = true;
      statusDiv.className = 'upload-status loading';
      statusDiv.textContent = "üîÑ Fetching tickets from Zendesk...";
      progressDiv.style.display = 'block';
      progressFill.style.width = '10%';
      progressFill.textContent = '10%';

      try {
        // Send request to backend with date range
        const response = await fetch('http://localhost:3000/auto-import-tickets', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            startDate: startDate,
            endDate: endDate,
            zendeskSubdomain: window.location.hostname.split('.')[0] // Extract subdomain
          }),
          mode: 'cors'
        });

        progressFill.style.width = '50%';
        progressFill.textContent = '50%';

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(errorData.error || `Server error: ${response.status}`);
        }

        const result = await response.json();
        
        progressFill.style.width = '100%';
        progressFill.textContent = '100%';

        statusDiv.className = 'upload-status success';
        statusDiv.innerHTML = `
          ‚úÖ Successfully imported!<br>
          üìä Tickets: ${result.ticketsProcessed}<br>
          üì¶ Chunks: ${result.totalChunks}<br>
          ‚è±Ô∏è Time: ${result.processingTime}
        `;

        setTimeout(() => {
          progressDiv.style.display = 'none';
        }, 2000);

      } catch (err) {
        console.error('‚ùå Auto-import error:', err);
        statusDiv.className = 'upload-status error';
        
        if (err.message === 'Failed to fetch') {
          statusDiv.textContent = `‚ùå Cannot connect to server. Make sure the backend is running on http://localhost:3000`;
        } else {
          statusDiv.textContent = `‚ùå Error: ${err.message}`;
        }
        
        progressDiv.style.display = 'none';
      } finally {
        btn.disabled = false;
      }
    });

    // File Upload Handler
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const uploadStatus = document.getElementById('uploadStatus');

    fileInput.addEventListener('change', handleFileUpload);

    // Drag and drop
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        handleFileUpload();
      }
    });

    async function handleFileUpload() {
      const file = fileInput.files[0];
      if (!file) return;

      uploadStatus.className = 'upload-status loading';
      uploadStatus.textContent = `‚è≥ Uploading ${file.name}...`;

      try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('http://localhost:3000/import-file', {
          method: 'POST',
          body: formData,
          mode: 'cors'
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(errorData.error || errorData.details || `Server error: ${response.status}`);
        }

        const result = await response.json();

        uploadStatus.className = 'upload-status success';
        uploadStatus.textContent = `‚úÖ Successfully imported: ${result.fileName}`;
      } catch (err) {
        console.error('‚ùå Upload error:', err);
        uploadStatus.className = 'upload-status error';
        
        if (err.message === 'Failed to fetch') {
          uploadStatus.textContent = `‚ùå Cannot connect to server. Make sure the backend is running`;
        } else {
          uploadStatus.textContent = `‚ùå Error: ${err.message}`;
        }
      } finally {
        fileInput.value = '';
      }
    }

    // Summarize in native language
    document.getElementById("summarizeBtnNative").addEventListener("click", async () => {
      const summaryBox = document.getElementById("summaryBox");
      const btn = document.getElementById("summarizeBtnNative");

      summaryBox.textContent = "Loading...";
      btn.disabled = true;

      try {
        const ticketData = await getCompleteTicketData();

        const agentDetails = await client.request({
          url: '/api/v2/users/me.json',
          type: 'GET'
        });

        ticketData.language = agentDetails.user.locale;

        const response = await client.request({
          url: "http://localhost:3000/summarize",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(ticketData),
          cors: true
        });

        summaryBox.textContent = response.summary;
      } catch (err) {
        summaryBox.textContent = "Error: " + (err.message || "Unknown error");
      } finally {
        btn.disabled = false;
      }
    });

    // Summarize in English
    document.getElementById("summarizeBtn").addEventListener("click", async () => {
      const summaryBox = document.getElementById("summaryBox");
      const btn = document.getElementById("summarizeBtn");

      summaryBox.textContent = "Loading...";
      btn.disabled = true;

      try {
        const ticketData = await getCompleteTicketData();

        const response = await client.request({
          url: "http://localhost:3000/summarize",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(ticketData),
          cors: true
        });

        summaryBox.textContent = response.summary;
      } catch (err) {
        summaryBox.textContent = "Error: " + (err.message || "Unknown error");
      } finally {
        btn.disabled = false;
      }
    });

    // Compose Reply
    document.getElementById("composeReplyBtn").addEventListener("click", async () => {
      const replyBox = document.getElementById("replyBox");
      const btn = document.getElementById("composeReplyBtn");
      const selectedTone = document.querySelector('input[name="tone"]:checked');
      const tone = selectedTone ? selectedTone.value : null;

      if (!tone) {
        replyBox.textContent = "Please select a reply tone first.";
        return;
      }

      replyBox.textContent = "Composing reply...";
      btn.disabled = true;

      try {
        const ticketData = await getCompleteTicketData();

        const response = await client.request({
          url: "http://localhost:3000/compose-reply",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            ...ticketData,
            tone
          }),
          cors: true
        });

        replyBox.textContent = response.reply;
      } catch (err) {
        replyBox.textContent = "‚ùå Failed to compose reply";
      } finally {
        btn.disabled = false;
      }
    });

    // Copy Reply
    document.getElementById("copyReplyBtn").addEventListener("click", async () => {
      const text = document.getElementById("replyBox").textContent;

      if (!text || text.includes("Reply will appear")) {
        alert("Please compose a reply first");
        return;
      }

      try {
        const htmlText = text
          .split('\n')
          .map(line => line.trim())
          .filter(line => line.length > 0)
          .join('<br><br>');
        
        await client.set('comment.text', htmlText);
        alert("‚úÖ Reply added to editor!");
      } catch (err) {
        console.error("Error setting text:", err);
        alert("‚ùå Failed to insert text");
      }
    });

    // Resize app
    client.invoke('resize', { width: '100%', height: '8000px' });
  </script>
</body>

</html>