<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Ticket Summarizer</title>
  <script src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 13px;
      padding: 12px;
    }

    h3 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 16px;
    }

    h4 {
      margin-bottom: 8px;
      margin-top: 16px;
      font-size: 14px;
    }

    .primary-btn {
      background: #1f73b7;
      color: white;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      width: 100%;
      font-size: 13px;
      margin-top: 8px;
      border: none;
    }

    .primary-btn:disabled {
      background: #c2d4e8;
      cursor: not-allowed;
    }

    .secondary-btn {
      margin-top: 6px;
      width: 100%;
      border: 1px solid #d8dcde;
      background: white;
      border-radius: 4px;
      padding: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    .secondary-btn:hover {
      background: #f8f9f9;
    }

    .secondary-btn:disabled {
      background: #f0f0f0;
      cursor: not-allowed;
      color: #999;
    }

    .reply-container {
      margin-top: 10px;
    }

    #replyBox {
      background: #f8f9f9;
      border: 1px solid #d8dcde;
      border-radius: 4px;
      padding: 8px;
      min-height: 100px;
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      resize: vertical;
      overflow-y: auto;
      width: calc(100% - 18px);
      color: #666;
    }

    #summaryBox {
      background: #f8f9f9;
      border: 1px solid #d8dcde;
      border-radius: 4px;
      padding: 8px;
      min-height: 100px;
      white-space: pre-wrap;
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.5;
    }

    .collapse-section {
      margin-top: 12px;
      background-color: #cbcfd3;
      border-radius: 5px;
      padding: 10px;
    }

    .collapse-header {
      cursor: pointer;
      padding: 8px;
      background: #f8f9f9;
      border: 1px solid #d8dcde;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }

    .collapse-content {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transform: translateY(-4px);
      transition:
        max-height 0.35s ease,
        opacity 0.25s ease,
        transform 0.25s ease;
    }

    .collapse-content.open {
      max-height: 500px;
      opacity: 1;
      transform: translateY(0);
    }

    .collapse-header:hover {
      background: #e8ebed;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
    }

    .arrow {
      transition: transform 0.2s;
    }

    .arrow.open {
      transform: rotate(90deg);
    }
  </style>
</head>

<body>
  <h3>ü§ñ AI Ticket Assistant</h3>

  <!-- Collapsible Summary Section -->
  <div class="collapse-section">
    <div class="collapse-header" onclick="toggleSection('summarySection')">
      <span>üìù Ticket Summary</span>
      <span class="arrow" id="summaryArrow">‚ñ∂</span>
    </div>

    <div class="collapse-content" id="summarySection">
      <select id="summaryLanguage" class="secondary-btn">
        <option>Loading languages...</option>
      </select>

      <button id="summarizeBtn" class="primary-btn">
        Generate Summary
      </button>

      <div id="summaryBox">Click to generate summary...</div>
    </div>
  </div>

  <script>
    // const BACKEND_URL = 'https://llm-replyer.onrender.com';
    const BACKEND_URL = 'http://localhost:3000';
    const client = ZAFClient.init();

    /* =========================
       UTILITIES
    ========================== */

    function toggleSection(sectionId) {
      const content = document.getElementById(sectionId);
      const arrow = document.getElementById(sectionId.replace('Section', 'Arrow'));
      content.classList.toggle('open');
      arrow.classList.toggle('open');
    }

    // Simple display formatter - backend now sends clean text
    function formatDisplay(text) {
      if (!text) return "";
      // Just add line breaks for display
      return text.replace(/\n/g, "<br>");
    }

    function showError(boxId, message) {
      const box = document.getElementById(boxId);
      if (box.tagName === 'TEXTAREA') {
        box.value = `‚ùå ${message}`;
      } else {
        box.innerHTML = `<span style="color: #cc0000;">‚ùå ${message}</span>`;
      }
    }

    /* =========================
       INITIALIZATION
    ========================== */

    // Store agent's locale and ticket locale globally
    let agentLocale = 'en-US'; // default
    let ticketLocale = 'en-US'; // default

    async function initLanguages() {
      try {
        const agent = await client.request('/api/v2/users/me.json');
        const localesRes = await client.request('/api/v2/locales/public.json');

        // Store agent's locale
        agentLocale = agent.user.locale;

        const dropdown = document.getElementById('summaryLanguage');
        dropdown.innerHTML = '';

        localesRes.locales.forEach(locale => {
          const opt = document.createElement('option');
          opt.value = locale.locale;
          opt.textContent = locale.name;

          if (locale.locale === agent.user.locale) {
            opt.selected = true;
          }

          dropdown.appendChild(opt);
        });
      } catch (e) {
        console.error('Failed to load languages', e);
        document.getElementById('summaryLanguage').innerHTML = '<option>English</option>';
      }
    }

    async function getCompleteTicketData() {
      const ticketData = await client.get('ticket');
      const ticketId = ticketData.ticket.id;

      const ticketResponse = await client.request(`/api/v2/tickets/${ticketId}.json`);
      const ticket = ticketResponse.ticket;

      // Get requester to determine ticket locale
      let requesterLocale = agentLocale;
      try {
        if (ticket.requester_id) {
          const requesterResponse = await client.request(`/api/v2/users/${ticket.requester_id}.json`);
          requesterLocale = requesterResponse.user.locale || agentLocale;
          ticketLocale = requesterLocale; // Store ticket locale globally
          console.log(`üìç Ticket locale detected: ${ticketLocale}`);
        }
      } catch (e) {
        console.warn('Could not fetch requester locale, using agent locale');
      }

      return {
        ticketId: ticket.id,
        subject: ticket.subject,
        description: ticket.description,
        status: ticket.status,
        priority: ticket.priority,
        tags: ticket.tags || [],
        locale: requesterLocale
      };
    }

    /* =========================
       TRANSLATE TEXT
    ========================== */

    async function translateText(text, targetLanguage) {
      try {
        console.log(`üåê Translating to ${targetLanguage}...`);
        
        const response = await client.request({
          url: `${BACKEND_URL}/translate`,
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            text: text,
            targetLanguage: targetLanguage
          }),
          cors: true
        });

        return response.translatedText;
      } catch (err) {
        console.error("Translation error:", err);
        throw err;
      }
    }

    /* =========================
       GENERATE SUMMARY
    ========================== */

    document.getElementById("summarizeBtn").addEventListener("click", async () => {
      const summaryBox = document.getElementById("summaryBox");
      const btn = document.getElementById("summarizeBtn");
      const language = document.getElementById("summaryLanguage").value;

      summaryBox.textContent = "Loading...";
      btn.disabled = true;

      try {
        const ticketData = await getCompleteTicketData();

        const response = await client.request({
          url: `${BACKEND_URL}/summarize`,
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            ...ticketData,
            language
          }),
          cors: true
        });

        summaryBox.innerHTML = formatDisplay(response.summary);

      } catch (err) {
        console.error("Summary error:", err);
        showError("summaryBox", "Failed to generate summary");
      } finally {
        btn.disabled = false;
      }
    });

    /* =========================
       INITIALIZE
    ========================== */

    initLanguages();
    client.invoke('resize', { width: '100%', height: '400px' });
  </script>
</body>

</html>