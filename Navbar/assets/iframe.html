<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AI Ticket Importer</title>
  <!-- Zendesk App Framework SDK -->
  <script src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>

  <style>
    /* ==================== RESET & BASE STYLES ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8f9f9;
      padding: 16px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    /* ==================== HEADER ==================== */
    .header {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #d8dcde;
    }

    .header h1 {
      font-size: 22px;
      font-weight: 600;
      color: #2f3941;
      margin-bottom: 4px;
    }

    .header p {
      font-size: 13px;
      color: #68737d;
    }

    /* ==================== SECTION ==================== */
    .section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #2f3941;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-description {
      font-size: 12px;
      color: #68737d;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    /* ==================== DATE PICKER ==================== */
    .date-picker-group {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .date-input-wrapper {
      flex: 1;
    }

    .date-input-wrapper label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #68737d;
      margin-bottom: 6px;
    }

    .date-input-wrapper input {
      width: 100%;
      padding: 10px;
      border: 1px solid #d8dcde;
      border-radius: 4px;
      font-size: 13px;
      transition: border-color 0.2s;
    }

    .date-input-wrapper input:focus {
      outline: none;
      border-color: #1f73b7;
      box-shadow: 0 0 0 3px rgba(31, 115, 183, 0.1);
    }

    /* ==================== BUTTONS ==================== */
    .primary-btn {
      background: #1f73b7;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 12px 16px;
      cursor: pointer;
      width: 100%;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .primary-btn:disabled {
      background: #c2d4e8;
      cursor: not-allowed;
    }

    .primary-btn:hover:not(:disabled) {
      background: #155a8a;
    }

    .secondary-btn {
      background: white;
      color: #1f73b7;
      border: 1px solid #1f73b7;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
      margin-top: 12px;
    }

    .secondary-btn:hover {
      background: #e8f4f8;
    }

    /* ==================== STATUS MESSAGES ==================== */
    .status-message {
      margin-top: 16px;
      padding: 12px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
      line-height: 1.6;
    }

    .status-message.success {
      background: #d4f4dd;
      border: 1px solid #0f5323;
      color: #0f5323;
      display: block;
    }

    .status-message.error {
      background: #ffd5d2;
      border: 1px solid #8c1d18;
      color: #8c1d18;
      display: block;
    }

    .status-message.loading {
      background: #fff4e0;
      border: 1px solid #8c6d1f;
      color: #8c6d1f;
      display: block;
    }

    .status-message.warning {
      background: #fff4e0;
      border: 1px solid #f79a3e;
      color: #8c6d1f;
      display: block;
    }

    /* ==================== PROGRESS BAR ==================== */
    .progress-bar {
      width: 100%;
      height: 28px;
      background: #f8f9f9;
      border: 1px solid #d8dcde;
      border-radius: 4px;
      margin-top: 16px;
      overflow: hidden;
      display: none;
    }

    .progress-bar.active {
      display: block;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #1f73b7, #2e8ed6);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }

    /* ==================== FILE UPLOAD SECTION ==================== */
    .file-upload-section {
      padding: 24px;
      background: #f8f9f9;
      border: 2px dashed #d8dcde;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-upload-section:hover {
      background: #e8ebed;
      border-color: #1f73b7;
    }

    .file-upload-section.dragover {
      background: #e8f4f8;
      border-color: #1f73b7;
      transform: scale(1.01);
    }

    #fileInput {
      display: none;
    }

    .file-label {
      color: #1f73b7;
      text-decoration: underline;
      cursor: pointer;
      font-weight: 500;
    }

    .file-info {
      font-size: 11px;
      color: #68737d;
      margin-top: 8px;
    }

    .upload-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    /* ==================== INFO BOX ==================== */
    .info-box {
      background: #e8f4f8;
      border-left: 4px solid #1f73b7;
      border-radius: 4px;
      padding: 12px;
      font-size: 12px;
      margin-top: 16px;
      color: #2f3941;
      line-height: 1.5;
    }

    /* ==================== HISTORY SECTION ==================== */
    .history-item {
      padding: 12px;
      background: #f8f9f9;
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .history-item:last-child {
      margin-bottom: 0;
    }

    .history-date {
      font-weight: 600;
      color: #2f3941;
      margin-bottom: 4px;
    }

    .history-stats {
      color: #68737d;
    }

    .no-history {
      text-align: center;
      color: #68737d;
      padding: 20px;
      font-size: 12px;
    }

    /* ==================== DIVIDER ==================== */
    .divider {
      height: 1px;
      background: #d8dcde;
      margin: 24px 0;
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- ==================== AUTO-IMPORT SECTION ==================== -->
    <div class="section">
      <div class="section-title">
        <span>üîÑ</span>
        <span>Auto-Import from Zendesk</span>
      </div>

      <div class="date-picker-group">
        <div class="date-input-wrapper">
          <label for="startDate">Start Date</label>
          <input type="date" id="startDate" />
        </div>

        <div class="date-input-wrapper">
          <label for="endDate">End Date</label>
          <input type="date" id="endDate" />
        </div>
      </div>

      <button id="autoImportBtn" class="primary-btn">
        <span>üì•</span>
        <span>Fetch & Import Tickets</span>
      </button>

      <div class="progress-bar" id="autoImportProgress">
        <div class="progress-fill" id="autoImportProgressFill">0%</div>
      </div>

      <div id="autoImportStatus" class="status-message"></div>
    </div>

    <!-- ==================== MANUAL FILE UPLOAD SECTION ==================== -->
    <div class="section">
      <div class="section-title">
        <span>üìÅ</span>
        <span>Manual Import</span>
      </div>

      <div class="file-upload-section" id="dropZone">
        <div class="upload-icon">üìÑ</div>
        <div>
          <p style="margin: 8px 0; font-size: 13px;">
            Drop file here or <label for="fileInput" class="file-label">browse</label>
          </p>
          <input type="file" id="fileInput" accept=".txt,.md,.csv,.json" />
          <div class="file-info">Supported: .txt, .md, .csv, .json</div>
        </div>
      </div>

      <div class="progress-bar" id="fileUploadProgress">
        <div class="progress-fill" id="fileUploadProgressFill">0%</div>
      </div>

      <div id="fileUploadStatus" class="status-message"></div>
    </div>

  </div>

  <script>
    // ============================================
    // CONFIGURATION - Change only this variable
    // ============================================
    const BACKEND_URL = 'http://localhost:3000';
    // const BACKEND_URL = 'https://llm-replyer.onrender.com';
    // ============================================

    // ==================== INITIALIZATION ====================
    const client = ZAFClient.init();

    // ==================== DEFAULT DATE SETUP ====================
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
    document.getElementById('endDate').valueAsDate = today;
    document.getElementById('startDate').valueAsDate = thirtyDaysAgo;

    // Notify user that the app has loaded
    client.invoke("notify", "Ticket Importer loaded ‚úÖ", "notice");

    // ==================== BACKEND CONNECTIVITY CHECK ====================
    async function checkBackendConnection() {
      try {
        const response = await fetch(`${BACKEND_URL}/health`, {
          method: 'GET',
          mode: 'cors'
        });
        
        if (response.ok) {
          console.log('‚úÖ Backend is connected and running');
        } else {
          console.warn('‚ö†Ô∏è Backend responded but with error:', response.status);
        }
      } catch (err) {
        console.error('‚ùå Cannot connect to backend server:', err);
        client.invoke("notify", "‚ö†Ô∏è Backend server not running. Start with: node server.js", "error");
      }
    }

    checkBackendConnection();

    // ==================== AUTO-IMPORT HANDLER ====================
    document.getElementById("autoImportBtn").addEventListener("click", async () => {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const statusDiv = document.getElementById("autoImportStatus");
      const progressDiv = document.getElementById("autoImportProgress");
      const progressFill = document.getElementById("autoImportProgressFill");
      const btn = document.getElementById("autoImportBtn");

      statusDiv.className = 'status-message';
      statusDiv.textContent = '';

      if (!startDate || !endDate) {
        statusDiv.className = 'status-message error';
        statusDiv.textContent = "‚ùå Please select both start and end dates";
        return;
      }

      if (new Date(startDate) > new Date(endDate)) {
        statusDiv.className = 'status-message error';
        statusDiv.textContent = "‚ùå Start date must be before end date";
        return;
      }

      btn.disabled = true;
      statusDiv.className = 'status-message loading';
      statusDiv.textContent = "üîÑ Fetching tickets from Zendesk...";
      progressDiv.classList.add('active');
      progressFill.style.width = '10%';
      progressFill.textContent = '10%';

      try {
        const response = await fetch(`${BACKEND_URL}/auto-import-tickets`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            startDate: startDate,
            endDate: endDate
          }),
          mode: 'cors'
        });

        progressFill.style.width = '50%';
        progressFill.textContent = '50%';

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          
          // Handle duplicate import specifically
          if (response.status === 409) {
            statusDiv.className = 'status-message warning';
            statusDiv.innerHTML = `
              ‚ö†Ô∏è <strong>Duplicate Import Detected</strong><br><br>
              Tickets from <strong>${startDate}</strong> to <strong>${endDate}</strong> were already imported:<br><br>
              üìÖ Import Date: ${new Date(errorData.existingImport.importDate).toLocaleString()}<br>
              üìä Tickets: ${errorData.existingImport.ticketsProcessed}<br>
              üì¶ Chunks: ${errorData.existingImport.totalChunks}<br>
              ‚è±Ô∏è Time: ${errorData.existingImport.processingTime}<br><br>
              üí° ${errorData.suggestion}
            `;
            progressDiv.classList.remove('active');
            return;
          }
          
          throw new Error(errorData.error || `Server error: ${response.status}`);
        }

        const result = await response.json();
        
        progressFill.style.width = '100%';
        progressFill.textContent = '100%';

        statusDiv.className = 'status-message success';
        statusDiv.innerHTML = `
          ‚úÖ <strong>Successfully imported!</strong><br><br>
          üìä Tickets: ${result.ticketsProcessed}<br>
          üì¶ Chunks: ${result.totalChunks}<br>
          ‚è±Ô∏è Time: ${result.processingTime}<br>
          ${result.sunshineEvent?.created ? '‚ú® Sunshine Event logged' : ''}
        `;

        client.invoke("notify", `‚úÖ Imported ${result.ticketsProcessed} tickets successfully!`, "notice");

        setTimeout(() => {
          progressDiv.classList.remove('active');
        }, 3000);

      } catch (err) {
        console.error('‚ùå Auto-import error:', err);
        statusDiv.className = 'status-message error';
        
        if (err.message === 'Failed to fetch') {
          statusDiv.textContent = `‚ùå Cannot connect to server. Make sure the backend is running on ${BACKEND_URL}`;
        } else {
          statusDiv.textContent = `‚ùå Error: ${err.message}`;
        }
        
        progressDiv.classList.remove('active');
        client.invoke("notify", "‚ùå Import failed. Check console for details.", "error");
      } finally {
        btn.disabled = false;
      }
    });

    // ==================== IMPORT HISTORY HANDLER ====================
    document.getElementById("loadHistoryBtn").addEventListener("click", async () => {
      const historyContainer = document.getElementById("historyContainer");
      const historyList = document.getElementById("historyList");
      const btn = document.getElementById("loadHistoryBtn");

      historyContainer.className = 'status-message loading';
      historyContainer.textContent = 'üîÑ Loading import history...';
      historyList.innerHTML = '';
      btn.disabled = true;

      try {
        const response = await fetch(`${BACKEND_URL}/import-history`, {
          method: 'GET',
          mode: 'cors'
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const result = await response.json();
        
        historyContainer.className = 'status-message';
        historyContainer.textContent = '';

        if (result.imports && result.imports.length > 0) {
          historyList.innerHTML = result.imports.map(item => `
            <div class="history-item">
              <div class="history-date">
                üìÖ ${new Date(item.importDate).toLocaleString()}
              </div>
              <div class="history-stats">
                üìä Date Range: ${item.dateRange.start} to ${item.dateRange.end}<br>
                üé´ Tickets: ${item.ticketsProcessed} | üì¶ Chunks: ${item.totalChunks} | ‚è±Ô∏è ${item.processingTime}
              </div>
            </div>
          `).join('');
        } else {
          historyList.innerHTML = '<div class="no-history">üì≠ No import history found</div>';
        }

      } catch (err) {
        console.error('‚ùå History error:', err);
        historyContainer.className = 'status-message error';
        historyContainer.textContent = `‚ùå Failed to load history: ${err.message}`;
      } finally {
        btn.disabled = false;
      }
    });

    // ==================== FILE UPLOAD HANDLER ====================
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const fileUploadStatus = document.getElementById('fileUploadStatus');
    const fileUploadProgress = document.getElementById('fileUploadProgress');
    const fileUploadProgressFill = document.getElementById('fileUploadProgressFill');

    fileInput.addEventListener('change', handleFileUpload);

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        handleFileUpload();
      }
    });

    dropZone.addEventListener('click', (e) => {
      if (e.target.tagName !== 'LABEL') {
        fileInput.click();
      }
    });

    async function handleFileUpload() {
      const file = fileInput.files[0];
      if (!file) return;

      fileUploadStatus.className = 'status-message loading';
      fileUploadStatus.textContent = `‚è≥ Uploading ${file.name}...`;
      fileUploadProgress.classList.add('active');
      fileUploadProgressFill.style.width = '30%';
      fileUploadProgressFill.textContent = '30%';

      try {
        const formData = new FormData();
        formData.append('file', file);

        fileUploadProgressFill.style.width = '60%';
        fileUploadProgressFill.textContent = '60%';

        const response = await fetch(`${BACKEND_URL}/import-file`, {
          method: 'POST',
          body: formData,
          mode: 'cors'
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(errorData.error || errorData.details || `Server error: ${response.status}`);
        }

        const result = await response.json();

        fileUploadProgressFill.style.width = '100%';
        fileUploadProgressFill.textContent = '100%';

        fileUploadStatus.className = 'status-message success';
        
        if (result.type === 'tickets') {
          fileUploadStatus.innerHTML = `
            ‚úÖ <strong>Successfully imported:</strong> ${result.fileName}<br><br>
            üìä Tickets: ${result.ticketsProcessed}<br>
            üì¶ Chunks: ${result.totalChunks}
          `;
        } else {
          fileUploadStatus.textContent = `‚úÖ Successfully imported: ${result.fileName}`;
        }

        client.invoke("notify", `‚úÖ File imported: ${result.fileName}`, "notice");

        setTimeout(() => {
          fileUploadProgress.classList.remove('active');
        }, 3000);

      } catch (err) {
        console.error('‚ùå Upload error:', err);
        fileUploadStatus.className = 'status-message error';
        
        if (err.message === 'Failed to fetch') {
          fileUploadStatus.textContent = `‚ùå Cannot connect to server. Make sure the backend is running`;
        } else {
          fileUploadStatus.textContent = `‚ùå Error: ${err.message}`;
        }
        
        fileUploadProgress.classList.remove('active');
        client.invoke("notify", "‚ùå Upload failed", "error");
      } finally {
        fileInput.value = '';
      }
    }

    // ==================== APP INITIALIZATION ====================
    client.invoke('resize', { width: '100%', height: '100%' });
  </script>
</body>
</html>